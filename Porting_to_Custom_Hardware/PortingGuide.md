# Porting of Example Projects Based on STMicroelectronics to Custom Hardware

This application note describes the process of porting hardware and software running on a STMicroelectronics development board to custom user hardware. This description is intended to help users to bridge the gap between starting with an example project and their own bespoke hardware that they will finally ship to their customers.

## Required Steps

Porting to a new device and your custom hardware is done in these five easy steps:

1. [Switch target device](#switch-target-device)
2. [Remove unavailable components](#remove-unavailable-components)
3. [Configure in STM32CubeMX](#configure-in-stm32cubemx)
4. [Update generated code](#update-generated-code)
5. [Configure in µVision](#configure-in-µVision)

## Switch Target Device

In your currently opened µVision project, go to **Project - Options for Target 'B-L475E-IOT01A'** (or press Alt+F7) and select the **Device** tab. Change the selected device to your new target device (here: STM32L496QEIx) and click OK:

![Options for target](images/stm32l496qeix.png "Change target device in the target options")

## Remove Unavailable Components 

Next, the **Manage Run-Time Environment** window opens which shows software components that are not available with your newly selected target device:

![Manage Run-Time Environment window](images/uv_unavailable_components.png "Remove unavailable software components")

- Deselect *all* components that are shown in red.
- Click OK.
- Close the project in µVision.

## Configure in STM32CubeMX

Before continuing, you need to remove the previously generated files by STM32CubeMX. Afterwards, you will create new ones for the new target device. This will also remove the entries in the `/* USER CODE */` sections of the files that are generated and editable. If you wish to keep these code snippets, make sure to save your work somewhere else.

Using your file manager, navigate to the project's subfolder `./RTE/Device` and delete the folder containing the previously used target device, for example *STM32L475VGTx*.

Switch back to µVision and reopen the project (from the **Project** menu item).

Go to **Project - Manage - Run-Time Environment** and expand **Device:STM32Cube Framework (API)**. Enable *STM32CubeMX* and click OK. An new window will ask to launch STM32CubeMX.:

![Start STM32CubeMX](images/start_cubemx.png "Start STM32CubeMX")

Pressing the **Start STM32CubeMX** button will launch the application and preconfigure it for the new target device. Configure the device as described in the [STM32Cube documentation](https://www.keil.com/pack/doc/STM32Cube/html/cubemx_using.html#cubemx_sys_config). Once done, switch back to µVision.

## Update Generated Code

In the previous step, it was mentioned that the user code in the generated files needs to be saved so that it can be reapplied now. For most example projects, the following is required to be added to the `main.c` file in the group **STM32CubeMX:Common Sources**:

Add the following `#include` statements:

```C
#include "cmsis_os2.h"
#include "RTE_Components.h"
#if defined(RTE_Compiler_EventRecorder)
#include "EventRecorder.h"
#endif
```

Add the following code:

- Configure system clocks and update system clock variable (add following code snippet):

```C
  /* Update SystemCoreClock variable */
  SystemCoreClockUpdate();
```

- Initialize Event Recorder (add following code snippet):

```C
#if defined(RTE_Compiler_EventRecorder) && \
    (defined(__MICROLIB) || \
    !(defined(RTE_CMSIS_RTOS2_RTX5) || defined(RTE_CMSIS_RTOS2_FreeRTOS)))
  EventRecorderInitialize(EventRecordAll, 1U);
#endif
```

- To start the CMSIS-RTOS2 kernel, add following code snippet:

```C
  osKernelInitialize();                         /* Initialize CMSIS-RTOS2 */
  app_initialize();                             /* Initialize application */
  osKernelStart();                              /* Start thread execution */
```

If in doubt, check the copy of the old generated files using a file compare tool.

## Configure in µVision

Finally, you need to configure the project to your needs. There's no general rule here what to do, but here are a couple of items that you can check:

- In the **Project** window, remove unnecessary files (not generated by STM32CubeMX, but added manually).
- In the **Manage Run-Time Environment** window:
  - Select appropriate software components (for example check the selected retargeting method under **Compiler:I/O:**).
  - Add required CMSIS-Drivers under the **CMSIS Driver** group (for example I2C, MCI, SPI, USART, VIO, WiFi).
- Ensure that CMSIS-Drivers are configured as specified. The documentation is accessible via the **Manage Run-Time Environment** window under the *Device::STM32Cube Framework(API)* component (check the **Description** column). Refer to the chapter: STM32L4 CMSIS-Drivers Configuration documentation.
- Configure the µVision project as you are used to for other development projects. For example, set compiler options,configure the debugger, and set stack and heap as required by the application. Do not forget to [locate Event Recorder in uninitialized memory](https://www.keil.com/pack/doc/compiler/EventRecorder/html/er_use.html#place_uninit_memory).
